<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hours Worked Registry</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .header-content {
            text-align: right;
            flex-grow: 1;
        }
        
        .header h1 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }
        
        .logo {
            width: 180px;
            height: 60px;
            object-fit: contain;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #138496);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            border: none;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #fd7e14);
            border: none;
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c82333);
            border: none;
        }
        
        .table th {
            background: #f8f9fa;
            color: var(--secondary-color);
            font-weight: 600;
            border-top: none;
        }
        
        .time-inputs {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .travel-time-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid var(--warning-color);
            display: none;
        }
        
        .alert-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
            min-width: 300px;
        }
        
        .calculated-hours {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }
        
        .travel-calculated-hours {
            background: #ffeaa7;
            color: #856404;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }
        
        .edit-mode {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
        }
        
        .storage-warning {
            background-color: #fff3cd;
            border-left: 4px solid var(--warning-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .header-content {
                text-align: center;
                width: 100%;
                margin-top: 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Storage Warning -->
        <div class="storage-warning" id="storageWarning" style="display: none;">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Local Storage Not Available</h5>
            <p class="mb-0">Your browser is blocking local storage. Data will be saved temporarily but will be lost when you close the browser.</p>
        </div>

        <!-- Header Section -->
        <div class="header">
            <img src="https://ethosautomation.com/wp-content/uploads/2022/04/Logo.png" alt="Ethos Automation Logo" class="logo">
            <div class="header-content">
                <h1>Hours Worked Registry</h1>
                <p>Track your work hours and travel time efficiently</p>
            </div>
        </div>

        <!-- Alert Box for Messages -->
        <div id="alertBox" class="alert-box"></div>

        <!-- Form Section -->
        <div class="card mb-4" id="formCard">
            <div class="card-header">
                <i class="fas fa-plus-circle me-2"></i><span id="formTitle">Register New Hours</span>
            </div>
            <div class="card-body">
                <form id="hourForm">
                    <input type="hidden" id="editId" value="">
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <label for="date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="date" required>
                        </div>
                        <div class="col-md-5 mb-3">
                            <label for="project" class="form-label">Project</label>
                            <input type="text" class="form-control" id="project" placeholder="Project name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" class="form-control" id="description" placeholder="Work description" required>
                        </div>
                    </div>

                    <div class="time-inputs">
                        <h5 class="mb-4"><i class="fas fa-clock me-2"></i>Work Schedule</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Start Time</label>
                                <div class="d-flex">
                                    <select class="form-control me-2" id="startHour" required>
                                        <option value="">Hour</option>
                                        <!-- Hours will be populated by JavaScript -->
                                    </select>
                                    <select class="form-control" id="startMinute" required>
                                        <option value="">Min</option>
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="setCurrentTime('start')">
                                    <i class="fas fa-clock me-1"></i>Now
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">End Time</label>
                                <div class="d-flex">
                                    <select class="form-control me-2" id="endHour" required>
                                        <option value="">Hour</option>
                                        <!-- Hours will be populated by JavaScript -->
                                    </select>
                                    <select class="form-control" id="endMinute" required>
                                        <option value="">Min</option>
                                        <option value="00">00</option>
                                        <option value="15">15</option>
                                        <option value="30">30</option>
                                        <option value="45">45</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-secondary mt-2" onclick="setCurrentTime('end')">
                                    <i class="fas fa-clock me-1"></i>Now
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Break Time (min)</label>
                                <select class="form-control" id="breakTime">
                                    <option value="0">0 min</option>
                                    <option value="15">15 min</option>
                                    <option value="30">30 min</option>
                                    <option value="45">45 min</option>
                                    <option value="60">60 min</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">Calculated Hours</label>
                                <div class="calculated-hours" id="calculatedHours">0:00 hours</div>
                                <div class="calculated-hours" id="calculatedTotalHours" style="background-color: #d1ecf1; display: none;">Total: 0:00 hours</div>
                            </div>
                        </div>

                        <!-- Travel Time Toggle -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeTravelTime">
                                    <label class="form-check-label" for="includeTravelTime">
                                        <i class="fas fa-car me-1"></i> Include travel time
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Travel Time Section -->
                        <div class="travel-time-section" id="travelTimeSection">
                            <h5 class="mb-4"><i class="fas fa-route me-2"></i>Travel Time</h5>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Travel Start Time</label>
                                    <div class="d-flex">
                                        <select class="form-control me-2" id="travelStartHour">
                                            <option value="">Hour</option>
                                            <!-- Hours will be populated by JavaScript -->
                                        </select>
                                        <select class="form-control" id="travelStartMinute">
                                            <option value="">Min</option>
                                            <option value="00">00</option>
                                            <option value="15">15</option>
                                            <option value="30">30</option>
                                            <option value="45">45</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Travel End Time</label>
                                    <div class="d-flex">
                                        <select class="form-control me-2" id="travelEndHour">
                                            <option value="">Hour</option>
                                            <!-- Hours will be populated by JavaScript -->
                                        </select>
                                        <select class="form-control" id="travelEndMinute">
                                            <option value="">Min</option>
                                            <option value="00">00</option>
                                            <option value="15">15</option>
                                            <option value="30">30</option>
                                            <option value="45">45</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Travel Time</label>
                                    <div class="travel-calculated-hours" id="calculatedTravelTime">0:00 hours</div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="travelDetails" class="form-label">Travel Details</label>
                                    <input type="text" class="form-control" id="travelDetails" placeholder="From office to client">
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12 d-flex justify-content-between">
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i><span id="saveButtonText">Save Record</span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="cancelEdit" style="display: none;">
                                        <i class="fas fa-times me-2"></i>Cancel Edit
                                    </button>
                                </div>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                    <i class="fas fa-redo me-2"></i>Reset Form
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Records Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-list me-2"></i>Hours Records
                </div>
                <div>
                    <button class="btn btn-sm btn-success me-2" id="generateReport">
                        <i class="fas fa-chart-pie me-1"></i>Generate Report
                    </button>
                    <button class="btn btn-sm btn-warning me-2" id="exportExcel">
                        <i class="fas fa-file-excel me-1"></i>Export to Excel
                    </button>
                    <button class="btn btn-sm btn-danger" id="clearStorage">
                        <i class="fas fa-trash me-1"></i>Clear All
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Project</th>
                                <th>Start - End</th>
                                <th>Hours</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsTable">
                            <tr>
                                <td colspan="6" class="text-center py-4" id="noRecords">
                                    <i class="fas fa-info-circle me-2"></i>No records found. Add your first record above.
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end total-hours">Total worked hours:</td>
                                <td class="total-hours" id="totalHours">0:00</td>
                                <td colspan="2"></td>
                            </tr>
                            <tr id="travelTimeTotalRow" style="display: none;">
                                <td colspan="3" class="text-end total-hours">Total travel time:</td>
                                <td class="total-hours" id="totalTravelTime">0:00</td>
                                <td colspan="2"></td>
                            </tr>
                            <tr id="grandTotalRow" style="display: none;">
                                <td colspan="3" class="text-end total-hours">Grand total:</td>
                                <td class="total-hours" id="grandTotal">0:00</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div class="card mt-4" id="reportSection" style="display: none;">
            <div class="card-header">
                <i class="fas fa-chart-bar me-2"></i>General Report
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Summary by Project</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Hours</th>
                                </tr>
                            </thead>
                            <tbody id="projectSummary">
                                <!-- Project summary will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Summary by Date</h6>
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Hours</th>
                                </tr>
                            </thead>
                            <tbody id="dateSummary">
                                <!-- Date summary will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-secondary" id="hideReport">
                        <i class="fas fa-times me-2"></i>Hide Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS (required for alert dismissal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variable to store records if localStorage is not available
        let memoryStorage = [];
        let storageAvailable = true;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check if localStorage is available
            storageAvailable = isLocalStorageAvailable();
            
            if (!storageAvailable) {
                document.getElementById('storageWarning').style.display = 'block';
                showAlert('Local storage is not available. Data will be saved in memory only.', 'warning');
            }
            
            // Set current date as default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // Populate hour dropdowns
            populateHourDropdowns();
            
            // Load any existing records
            loadRecords();
            
            // Setup event listeners
            document.getElementById('hourForm').addEventListener('submit', function(e) {
                e.preventDefault();
                if (document.getElementById('editId').value) {
                    updateRecord();
                } else {
                    saveRecord();
                }
            });
            
            document.getElementById('exportExcel').addEventListener('click', exportToExcel);
            document.getElementById('clearStorage').addEventListener('click', clearStorage);
            document.getElementById('generateReport').addEventListener('click', generateReport);
            document.getElementById('hideReport').addEventListener('click', hideReport);
            document.getElementById('cancelEdit').addEventListener('click', cancelEdit);
            
            // Travel time toggle
            document.getElementById('includeTravelTime').addEventListener('change', function() {
                document.getElementById('travelTimeSection').style.display = this.checked ? 'block' : 'none';
                calculateTotalHours();
            });
            
            // Add change listeners to time inputs for auto-calculation
            document.getElementById('startHour').addEventListener('change', calculateHours);
            document.getElementById('startMinute').addEventListener('change', calculateHours);
            document.getElementById('endHour').addEventListener('change', calculateHours);
            document.getElementById('endMinute').addEventListener('change', calculateHours);
            document.getElementById('breakTime').addEventListener('change', calculateHours);
            
            // Travel time calculation listeners
            document.getElementById('travelStartHour').addEventListener('change', calculateTravelTime);
            document.getElementById('travelStartMinute').addEventListener('change', calculateTravelTime);
            document.getElementById('travelEndHour').addEventListener('change', calculateTravelTime);
            document.getElementById('travelEndMinute').addEventListener('change', calculateTravelTime);
            
            showAlert('Application loaded successfully!', 'success');
        }

        function isLocalStorageAvailable() {
            try {
                const test = 'test';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        function getStorage() {
            if (storageAvailable) {
                try {
                    const storedRecords = localStorage.getItem('hourRecords');
                    return storedRecords ? JSON.parse(storedRecords) : [];
                } catch (e) {
                    console.error('Error reading from localStorage:', e);
                    storageAvailable = false;
                    document.getElementById('storageWarning').style.display = 'block';
                    return memoryStorage;
                }
            } else {
                return memoryStorage;
            }
        }

        function setStorage(records) {
            if (storageAvailable) {
                try {
                    localStorage.setItem('hourRecords', JSON.stringify(records));
                } catch (e) {
                    console.error('Error saving to localStorage:', e);
                    storageAvailable = false;
                    document.getElementById('storageWarning').style.display = 'block';
                    memoryStorage = records;
                }
            } else {
                memoryStorage = records;
            }
        }

        function populateHourDropdowns() {
            const hourSelects = ['startHour', 'endHour', 'travelStartHour', 'travelEndHour'];
            
            hourSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                // Clear existing options except the first one
                while(select.options.length > 1) {
                    select.remove(1);
                }
                
                for (let i = 0; i < 24; i++) {
                    const option = document.createElement('option');
                    const hour = i.toString().padStart(2, '0');
                    option.value = hour;
                    option.textContent = hour;
                    select.appendChild(option);
                }
            });
        }

        function setCurrentTime(field) {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(Math.floor(now.getMinutes() / 15) * 15).padStart(2, '0');
            
            if (field === 'start') {
                document.getElementById('startHour').value = hours;
                document.getElementById('startMinute').value = minutes;
            } else if (field === 'end') {
                document.getElementById('endHour').value = hours;
                document.getElementById('endMinute').value = minutes;
            }
            
            calculateHours();
        }

        function calculateHours() {
            const startHour = document.getElementById('startHour').value;
            const startMinute = document.getElementById('startMinute').value;
            const endHour = document.getElementById('endHour').value;
            const endMinute = document.getElementById('endMinute').value;
            const breakTime = parseInt(document.getElementById('breakTime').value) || 0;
            
            if (!startHour || !startMinute || !endHour || !endMinute) {
                document.getElementById('calculatedHours').textContent = '0:00 hours';
                calculateTotalHours();
                return 0;
            }
            
            // Calculate total minutes
            const startTotalMinutes = parseInt(startHour) * 60 + parseInt(startMinute);
            let endTotalMinutes = parseInt(endHour) * 60 + parseInt(endMinute);
            
            // Handle overnight shifts
            if (endTotalMinutes < startTotalMinutes) {
                endTotalMinutes += 24 * 60;
            }
            
            let totalMinutes = endTotalMinutes - startTotalMinutes - breakTime;
            
            if (totalMinutes < 0) {
                totalMinutes = 0;
            }
            
            // Convert to hours and minutes
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            // Update display
            document.getElementById('calculatedHours').textContent = 
                `${hours}:${minutes.toString().padStart(2, '0')} hours`;
                
            calculateTotalHours();
            return totalMinutes;
        }

        function calculateTravelTime() {
            const travelStartHour = document.getElementById('travelStartHour').value;
            const travelStartMinute = document.getElementById('travelStartMinute').value;
            const travelEndHour = document.getElementById('travelEndHour').value;
            const travelEndMinute = document.getElementById('travelEndMinute').value;
            
            if (!travelStartHour || !travelStartMinute || !travelEndHour || !travelEndMinute) {
                document.getElementById('calculatedTravelTime').textContent = '0:00 hours';
                calculateTotalHours();
                return 0;
            }
            
            // Calculate total minutes
            const startTotalMinutes = parseInt(travelStartHour) * 60 + parseInt(travelStartMinute);
            let endTotalMinutes = parseInt(travelEndHour) * 60 + parseInt(travelEndMinute);
            
            // Handle overnight travel
            if (endTotalMinutes < startTotalMinutes) {
                endTotalMinutes += 24 * 60;
            }
            
            let totalMinutes = endTotalMinutes - startTotalMinutes;
            
            if (totalMinutes < 0) {
                totalMinutes = 0;
            }
            
            // Convert to hours and minutes
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            // Update display
            document.getElementById('calculatedTravelTime').textContent = 
                `${hours}:${minutes.toString().padStart(2, '0')} hours`;
                
            calculateTotalHours();
            return totalMinutes;
        }

        function calculateTotalHours() {
            const workedMinutes = calculateHours();
            const includeTravel = document.getElementById('includeTravelTime').checked;
            const travelMinutes = includeTravel ? calculateTravelTime() : 0;
            
            if (includeTravel && travelMinutes > 0) {
                const totalMinutes = workedMinutes + travelMinutes;
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                
                document.getElementById('calculatedTotalHours').textContent = 
                    `Total: ${hours}:${minutes.toString().padStart(2, '0')} hours`;
                document.getElementById('calculatedTotalHours').style.display = 'inline-block';
            } else {
                document.getElementById('calculatedTotalHours').style.display = 'none';
            }
        }

        function saveRecord() {
            // Get form values
            const date = document.getElementById('date').value;
            const project = document.getElementById('project').value;
            const description = document.getElementById('description').value;
            const startHour = document.getElementById('startHour').value;
            const startMinute = document.getElementById('startMinute').value;
            const endHour = document.getElementById('endHour').value;
            const endMinute = document.getElementById('endMinute').value;
            const breakTime = document.getElementById('breakTime').value;
            const includeTravel = document.getElementById('includeTravelTime').checked;
            const travelStartHour = document.getElementById('travelStartHour').value;
            const travelStartMinute = document.getElementById('travelStartMinute').value;
            const travelEndHour = document.getElementById('travelEndHour').value;
            const travelEndMinute = document.getElementById('travelEndMinute').value;
            const travelDetails = document.getElementById('travelDetails').value;
            
            // Validate required fields
            if (!date || !project || !description || !startHour || !startMinute || !endHour || !endMinute) {
                showAlert('Please fill in all required fields', 'danger');
                return;
            }
            
            if (includeTravel && (!travelStartHour || !travelStartMinute || !travelEndHour || !travelEndMinute)) {
                showAlert('Please complete travel time fields', 'danger');
                return;
            }
            
            // Calculate times
            const workedMinutes = calculateHours();
            const travelMinutes = includeTravel ? calculateTravelTime() : 0;
            const totalMinutes = workedMinutes + travelMinutes;
            
            // Convert to display format
            const workedHoursFormatted = document.getElementById('calculatedHours').textContent;
            const travelHoursFormatted = includeTravel ? document.getElementById('calculatedTravelTime').textContent : '';
            const totalHoursFormatted = includeTravel ? 
                `${Math.floor(totalMinutes / 60)}:${(totalMinutes % 60).toString().padStart(2, '0')} hours` : 
                workedHoursFormatted;
            
            // Create record object
            const record = {
                id: Date.now(),
                date: date,
                project: project,
                description: description,
                startTime: `${startHour}:${startMinute}`,
                endTime: `${endHour}:${endMinute}`,
                breakTime: breakTime,
                hours: workedHoursFormatted,
                minutes: workedMinutes,
                includeTravel: includeTravel,
                travelStartTime: includeTravel ? `${travelStartHour}:${travelStartMinute}` : '',
                travelEndTime: includeTravel ? `${travelEndHour}:${travelEndMinute}` : '',
                travelMinutes: travelMinutes,
                travelHours: travelHoursFormatted,
                travelDetails: travelDetails,
                totalMinutes: totalMinutes,
                totalHours: totalHoursFormatted
            };
            
            // Save to storage
            const records = getStorage();
            records.push(record);
            setStorage(records);
            
            showAlert('Record saved successfully!', 'success');
            
            // Reset form
            resetForm();
            
            // Reload records table
            loadRecords();
        }

        function updateRecord() {
            const id = document.getElementById('editId').value;
            
            // Get form values
            const date = document.getElementById('date').value;
            const project = document.getElementById('project').value;
            const description = document.getElementById('description').value;
            const startHour = document.getElementById('startHour').value;
            const startMinute = document.getElementById('startMinute').value;
            const endHour = document.getElementById('endHour').value;
            const endMinute = document.getElementById('endMinute').value;
            const breakTime = document.getElementById('breakTime').value;
            const includeTravel = document.getElementById('includeTravelTime').checked;
            const travelStartHour = document.getElementById('travelStartHour').value;
            const travelStartMinute = document.getElementById('travelStartMinute').value;
            const travelEndHour = document.getElementById('travelEndHour').value;
            const travelEndMinute = document.getElementById('travelEndMinute').value;
            const travelDetails = document.getElementById('travelDetails').value;
            
            // Validate required fields
            if (!date || !project || !description || !startHour || !startMinute || !endHour || !endMinute) {
                showAlert('Please fill in all required fields', 'danger');
                return;
            }
            
            if (includeTravel && (!travelStartHour || !travelStartMinute || !travelEndHour || !travelEndMinute)) {
                showAlert('Please complete travel time fields', 'danger');
                return;
            }
            
            // Calculate times
            const workedMinutes = calculateHours();
            const travelMinutes = includeTravel ? calculateTravelTime() : 0;
            const totalMinutes = workedMinutes + travelMinutes;
            
            // Convert to display format
            const workedHoursFormatted = document.getElementById('calculatedHours').textContent;
            const travelHoursFormatted = includeTravel ? document.getElementById('calculatedTravelTime').textContent : '';
            const totalHoursFormatted = includeTravel ? 
                `${Math.floor(totalMinutes / 60)}:${(totalMinutes % 60).toString().padStart(2, '0')} hours` : 
                workedHoursFormatted;
            
            // Get existing records
            const records = getStorage();
            
            // Find and update record
            const recordIndex = records.findIndex(record => record.id == id);
            if (recordIndex === -1) {
                showAlert('Record not found', 'danger');
                return;
            }
            
            records[recordIndex] = {
                id: id,
                date: date,
                project: project,
                description: description,
                startTime: `${startHour}:${startMinute}`,
                endTime: `${endHour}:${endMinute}`,
                breakTime: breakTime,
                hours: workedHoursFormatted,
                minutes: workedMinutes,
                includeTravel: includeTravel,
                travelStartTime: includeTravel ? `${travelStartHour}:${travelStartMinute}` : '',
                travelEndTime: includeTravel ? `${travelEndHour}:${travelEndMinute}` : '',
                travelMinutes: travelMinutes,
                travelHours: travelHoursFormatted,
                travelDetails: travelDetails,
                totalMinutes: totalMinutes,
                totalHours: totalHoursFormatted
            };
            
            setStorage(records);
            showAlert('Record updated successfully!', 'success');
            
            // Reset form and exit edit mode
            resetForm();
            exitEditMode();
            
            // Reload records table
            loadRecords();
        }

        function editRecord(id) {
            // Get existing records
            const records = getStorage();
            
            // Find the record
            const record = records.find(record => record.id == id);
            if (!record) {
                showAlert('Record not found', 'danger');
                return;
            }
            
            // Enter edit mode
            enterEditMode();
            
            // Fill form with record data
            document.getElementById('editId').value = record.id;
            document.getElementById('date').value = record.date;
            document.getElementById('project').value = record.project;
            document.getElementById('description').value = record.description;
            
            // Set work time
            const [startHour, startMinute] = record.startTime.split(':');
            document.getElementById('startHour').value = startHour;
            document.getElementById('startMinute').value = startMinute;
            
            const [endHour, endMinute] = record.endTime.split(':');
            document.getElementById('endHour').value = endHour;
            document.getElementById('endMinute').value = endMinute;
            
            document.getElementById('breakTime').value = record.breakTime;
            
            // Set travel time if exists
            if (record.includeTravel) {
                document.getElementById('includeTravelTime').checked = true;
                document.getElementById('travelTimeSection').style.display = 'block';
                
                if (record.travelStartTime) {
                    const [travelStartHour, travelStartMinute] = record.travelStartTime.split(':');
                    document.getElementById('travelStartHour').value = travelStartHour;
                    document.getElementById('travelStartMinute').value = travelStartMinute;
                }
                
                if (record.travelEndTime) {
                    const [travelEndHour, travelEndMinute] = record.travelEndTime.split(':');
                    document.getElementById('travelEndHour').value = travelEndHour;
                    document.getElementById('travelEndMinute').value = travelEndMinute;
                }
                
                document.getElementById('travelDetails').value = record.travelDetails || '';
            } else {
                document.getElementById('includeTravelTime').checked = false;
                document.getElementById('travelTimeSection').style.display = 'none';
            }
            
            // Calculate and display hours
            calculateTotalHours();
            
            // Scroll to form
            document.getElementById('formCard').scrollIntoView({ behavior: 'smooth' });
            
            showAlert('Now editing record', 'info');
        }

        function enterEditMode() {
            document.getElementById('formTitle').textContent = 'Edit Hours Record';
            document.getElementById('saveButtonText').textContent = 'Update Record';
            document.getElementById('cancelEdit').style.display = 'inline-block';
            document.getElementById('formCard').classList.add('edit-mode');
        }

        function exitEditMode() {
            document.getElementById('formTitle').textContent = 'Register New Hours';
            document.getElementById('saveButtonText').textContent = 'Save Record';
            document.getElementById('cancelEdit').style.display = 'none';
            document.getElementById('formCard').classList.remove('edit-mode');
            document.getElementById('editId').value = '';
        }

        function cancelEdit() {
            resetForm();
            exitEditMode();
            showAlert('Edit cancelled', 'info');
        }

        function resetForm() {
            document.getElementById('hourForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            document.getElementById('travelTimeSection').style.display = 'none';
            document.getElementById('calculatedHours').textContent = '0:00 hours';
            document.getElementById('calculatedTravelTime').textContent = '0:00 hours';
            document.getElementById('calculatedTotalHours').style.display = 'none';
            exitEditMode();
        }

        function loadRecords() {
            const records = getStorage();
            const tableBody = document.getElementById('recordsTable');
            const noRecords = document.getElementById('noRecords');
            
            if (records.length === 0) {
                noRecords.style.display = 'table-cell';
                document.getElementById('travelTimeTotalRow').style.display = 'none';
                document.getElementById('grandTotalRow').style.display = 'none';
                return;
            }
            
            noRecords.style.display = 'none';
            tableBody.innerHTML = '';
            
            let totalWorkedMinutes = 0;
            let totalTravelMinutes = 0;
            let hasTravelTime = false;
            
            records.forEach(record => {
                totalWorkedMinutes += record.minutes;
                totalTravelMinutes += record.travelMinutes || 0;
                
                if (record.includeTravel && record.travelMinutes > 0) {
                    hasTravelTime = true;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.project}</td>
                    <td>
                        ${record.startTime} - ${record.endTime}
                        ${record.includeTravel ? `<div class="mt-1"><small class="text-muted"><i class="fas fa-car me-1"></i>Travel: ${record.travelStartTime} - ${record.travelEndTime}</small></div>` : ''}
                    </td>
                    <td>
                        ${record.hours}
                        ${record.includeTravel ? `<div class="mt-1"><small class="text-muted">Travel: ${record.travelHours}</small></div>` : ''}
                        ${record.includeTravel ? `<div class="mt-1"><small class="text-primary">Total: ${record.totalHours}</small></div>` : ''}
                    </td>
                    <td>
                        ${record.description}
                        ${record.travelDetails ? `<div class="mt-1"><small class="text-muted"><i class="fas fa-info-circle me-1"></i>${record.travelDetails}</small></div>` : ''}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="editRecord(${record.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecord(${record.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            // Update totals
            const totalWorkedHours = `${Math.floor(totalWorkedMinutes / 60)}:${(totalWorkedMinutes % 60).toString().padStart(2, '0')}`;
            document.getElementById('totalHours').textContent = totalWorkedHours;
            
            if (hasTravelTime) {
                const totalTravelHours = `${Math.floor(totalTravelMinutes / 60)}:${(totalTravelMinutes % 60).toString().padStart(2, '0')}`;
                const grandTotal = `${Math.floor((totalWorkedMinutes + totalTravelMinutes) / 60)}:${((totalWorkedMinutes + totalTravelMinutes) % 60).toString().padStart(2, '0')}`;
                
                document.getElementById('totalTravelTime').textContent = totalTravelHours;
                document.getElementById('grandTotal').textContent = grandTotal;
                
                document.getElementById('travelTimeTotalRow').style.display = '';
                document.getElementById('grandTotalRow').style.display = '';
            } else {
                document.getElementById('travelTimeTotalRow').style.display = 'none';
                document.getElementById('grandTotalRow').style.display = 'none';
            }
        }

        function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) {
                return;
            }
            
            const records = getStorage();
            const newRecords = records.filter(record => record.id !== id);
            setStorage(newRecords);
            
            showAlert('Record deleted successfully', 'success');
            loadRecords();
        }

        function clearStorage() {
            if (!confirm('Are you sure you want to delete ALL records? This cannot be undone.')) {
                return;
            }
            
            setStorage([]);
            showAlert('All records have been deleted', 'success');
            loadRecords();
        }

        function generateReport() {
            const records = getStorage();
            
            if (records.length === 0) {
                showAlert('No records to generate report', 'warning');
                return;
            }
            
            // Summary by project
            const projectSummary = {};
            let totalMinutes = 0;
            
            records.forEach(record => {
                if (!projectSummary[record.project]) {
                    projectSummary[record.project] = 0;
                }
                projectSummary[record.project] += record.totalMinutes || record.minutes;
                totalMinutes += record.totalMinutes || record.minutes;
            });
            
            // Generate HTML for project summary
            let projectHTML = '';
            for (const project in projectSummary) {
                const hours = Math.floor(projectSummary[project] / 60);
                const minutes = projectSummary[project] % 60;
                projectHTML += `
                    <tr>
                        <td>${project}</td>
                        <td>${hours}:${minutes.toString().padStart(2, '0')}</td>
                    </tr>
                `;
            }
            document.getElementById('projectSummary').innerHTML = projectHTML;
            
            // Summary by month (grouping by year-month)
            const monthlySummary = {};
            
            records.forEach(record => {
                const yearMonth = record.date.substring(0, 7);
                if (!monthlySummary[yearMonth]) {
                    monthlySummary[yearMonth] = 0;
                }
                monthlySummary[yearMonth] += record.totalMinutes || record.minutes;
            });
            
            // Generate HTML for date summary
            let dateHTML = '';
            for (const month in monthlySummary) {
                const [year, monthNum] = month.split('-');
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                   'July', 'August', 'September', 'October', 'November', 'December'];
                const monthName = monthNames[parseInt(monthNum) - 1];
                
                const hours = Math.floor(monthlySummary[month] / 60);
                const minutes = monthlySummary[month] % 60;
                
                dateHTML += `
                    <tr>
                        <td>${monthName} ${year}</td>
                        <td>${hours}:${minutes.toString().padStart(2, '0')}</td>
                    </tr>
                `;
            }
            document.getElementById('dateSummary').innerHTML = dateHTML;
            
            // Show reports section
            document.getElementById('reportSection').style.display = 'block';
            
            showAlert('Report generated successfully', 'success');
        }

        function hideReport() {
            document.getElementById('reportSection').style.display = 'none';
        }

        function exportToExcel() {
            const records = getStorage();
            
            if (records.length === 0) {
                showAlert('No records to export', 'warning');
                return;
            }
            
            // Prepare data for export
            const data = records.map(record => ({
                'Date': record.date,
                'Project': record.project,
                'Start Time': record.startTime,
                'End Time': record.endTime,
                'Break Time (min)': record.breakTime,
                'Worked Hours': record.hours,
                'Includes Travel': record.includeTravel ? 'Yes' : 'No',
                'Travel Start Time': record.travelStartTime || '',
                'Travel End Time': record.travelEndTime || '',
                'Travel Time': record.travelHours || '',
                'Travel Details': record.travelDetails || '',
                'Total Hours': record.totalHours || record.hours,
                'Description': record.description
            }));
            
            // Convert data to worksheet
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Hours Records');
            
            // Generate Excel file and trigger download
            XLSX.writeFile(workbook, 'hours_registry.xlsx');
            showAlert('Excel file downloaded successfully', 'success');
        }

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            // Auto-close alert after 5 seconds
            setTimeout(() => {
                const alert = alertBox.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => alertBox.innerHTML = '', 500);
                }
            }, 5000);
        }
    </script>
</body>
</html>
